@Scripts.Render("~/bundles/datetimepickerJs")
@Styles.Render("~/bundles/datetimepickerCss")
@Styles.Render("~/bundles/less")

<script type="text/template" id="tempQueryParams">
    <% for(var i=0;i<=data.length-1;i++){%>
        <% if(data[i].ParamType==0 || data[i].ParamType==1) {%>
            <% if(data[i].ParamInputType==0) {%>
                <div class="form-group">
                    <label class="sr-only" for="<%=data[i].ParamCode%>"><%=data[i].ParamName==''?data[i].ParamCode:data[i].ParamName%></label>
                    <input id="<%=data[i].ParamCode%>" data-index="<%=i%>" data-paramtype="<%=data[i].ParamType%>" class="form-control" name="<%=data[i].ParamCode%>" type="text" placeholder="输入<%=data[i].ParamName==''? data[i].ParamCode:data[i].ParamName%>" />
                </div>
            <%} else if(data[i].ParamInputType==1) {%>
                <div class="form-group">
                    <label class="sr-only"><%=data[i].ParamCode%></label>
                    <div class="input-group">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="btn_<%=data[i].ParamCode%>">
                                <%=data[i].ParamName==""?data[i].ParamCode:data[i].ParamName%> <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                <% for(var j=0;j<=data[i].ParamItems.length-1;j++) {%>
                                <li class="list_input" data-index="<%=i%>" data-display="<%=(data[i].ParamName==''?data[i].ParamCode:data[i].ParamName)+'--'+ (data[i].ParamItems[j].OptionName)%>" data-paramitemvalue="<%=data[i].ParamItems[j].OptionValue%>" data-paramcode="<%=data[i].ParamItems[j].ParamCode%>"><a href="#do"><%=data[i].ParamItems[j].OptionName%></a></li>
                                <%}%>
                            </ul>
                        </div>
                        <span class="input-group-btn">
                            <a class="btn btn-default clearBtn"  data-paramcode="<%=data[i].ParamCode%>" data-index="<%=i%>">
                                <span class="glyphicon glyphicon-remove"></span>
                            </a>
                        </span>
                    </div>
                    
                </div>
                <%}%>
        <%} else if(data[i].ParamType==2) {%>
            <div class="form-group">
                <label for="<%=data[i].ParamCode%>" class="sr-only "><%=data[i].ParamName%></label>
                <input type="hidden" id="<%=data[i].ParamCode%>" value="" />
                <div class="input-group date form_datetime" data-link-field="<%=data[i].ParamCode%>">
                    <input class="form-control" size="18" data-index="<%=i%>" placeholder="输入<%=data[i].ParamName==''?data[i].ParamCode:data[i].ParamName%>" type="text" value="" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                </div>
            </div>
        <%}%>
    <%}%>
</script>

<script type="text/template" id="tempReportHeader">
    <% for(var i=0 ;i<=data.length-1;i++) {%>
    <%if(data[i].Sortabled){%>
    <th data-index="<%=i%>" style="cursor:pointer">
        <% if(data[i].SortValue==0){%>
        <span class="glyphicon glyphicon-sort"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></span>
        <%} else if(data[i].SortValue==1){%>
        <% if(data[i].ColumnType==0) {%>
        <span class="glyphicon glyphicon-sort-by-alphabet"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></span>
        <%} else if(data[i].ColumnType==1){%>
        <span class="glyphicon glyphicon-sort-by-order"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></span>
        <%} else if(data[i].ColumnType==2){%>
        <span class="glyphicon glyphicon-sort-by-attributes"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></span>
        <%}%>

        <%} else if(data[i].SortValue==2){%>
        <% if(data[i].ColumnType==0) {%>
        <span class="glyphicon glyphicon-sort-by-alphabet-alt"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></span>
        <%} else if(data[i].ColumnType==1){%>
        <span class="glyphicon glyphicon-sort-by-order-alt"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></span>
        <%} else if(data[i].ColumnType==2){%>
        <span class="glyphicon glyphicon-sort-by-attributes-alt"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></span>
        <%}%>
        <%}%>
    </th>
    <%} else {%>
    <th data-index="<%=i%>" style="cursor:pointer"><span class="text-primary"><%=data[i].ColumnName==""?data[i].ColumnCode:data[i].ColumnName%></span></th>
    <% }%>
    <%}%>
</script>

<script type="text/template" id="tempReportBody">
    <tr>
        <td>1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
    </tr>
</script>

<script type="text/template" id="tempReportFooter">
    <tr>
        <td>页合计</td>
        <td></td>
        <td></td>
        <td></td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
    </tr>
    <tr>
        <td>总合计</td>
        <td></td>
        <td></td>
        <td></td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
        <td>colmn1</td>
    </tr>
</script>

<script id="tempReportPager" type="text/template">
    <center>
        <ul class="pagination">
            <li><a href="#prePage"><span class="glyphicon glyphicon-chevron-left"></span></a></li>
            <li><a href="#goHome"><span class="glyphicon glyphicon-home"></span></a></li>
            <li><a href="#nextPage"><span class="glyphicon glyphicon-chevron-right"></span></a></li>
        </ul>
    </center>
</script>

<script type="text/javascript">
    if (window.Report.Report == undefined) {
        window.Report.Report = Backbone.Model.extend({
            defaults: {
                "ID": null,
                "DBID": null,
                "ReportName": "",
                "Remark": "",
                "Columns": [],
                "Params": [],
                "PageSumabled": false,
                "AllSumabled": false,
                "Pagingabled": false,
                "PageSize": 10
            },
            idAttribute: "ID",
            urlRoot: "/api/Report"
        });
    }
    if (window.Report.Request == undefined) {
        window.Report.Request = Backbone.Model.extend({
            defaults: {
                ReportID: "@ViewBag.ReportID",
                Page: 1,
                Params: [],
                SortColumn: "",
                Desc:false
            }
        });
    }
    if (window.Report.ToolbarView == undefined) {
        window.Report.ToolbarView = Backbone.View.extend({
            events: {
                "click a":"btnClick"
            },
            btnClick: function (e) {
                switch ($(e.currentTarget).attr("data-action")) {
                    case "query":
                        $.post("/api/QueryReport",
                            request.toJSON(),
                            function (rst) {
                                if (rst.ResultStatus != 1) {
                                    alert(rst.ResultMessage);
                                    return;
                                }
                                reportResult = rst.ResultObj;
                                reportView.showQuery();
                            });
                    break;
                }
            }
        });
    }
    if (window.Report.QueryParamsView == undefined) {
        window.Report.QueryParamsView = Backbone.View.extend({
            template: _.template($("#tempQueryParams").html()),
            initialize:function(){
                report.fetch({
                    data: {
                        id: "@ViewBag.ReportID",
                        forQuery: true
                    },
                    success: function (model, rst) {
                        $("#queryTitle").html(rst.ReportName);
                        request.set("Params", rst.Params);
                        queryParamsView.render();
                        $(".form_datetime").datetimepicker({
                            format: "yyyy-MM-dd hh:ii",
                            autoclose: true,
                            todayBtn: true,
                            todayHighlight: true,
                            language: "zh-CN"
                        });
                    },
                    error: function () {
                        alert("获取报表信息失败");
                    }
                });
            },
            render: function () {
                this.$el.html(this.template({ data: report.get("Params") }));
            },
            events: {
                "change input": "valueChanged",
                "click .list_input": "chooseListItem",
                "click .clearBtn": "clearListChoose"
            },
            valueChanged: function (e) {
                var input = $(e.currentTarget);
                var index = input.attr("data-index");
                request.get("Params")[index].ParamValue=input.val();
            },
            chooseListItem: function (e) {
                var index = $(e.currentTarget).attr("data-index");
                var value = $(e.currentTarget).attr("data-paramitemvalue");
                request.get("Params")[index].ParamValue = value;
                this.$el.find(".list_input").removeClass("active");
                $(e.currentTarget).addClass("active");
                $("#btn_" + $(e.currentTarget).attr("data-paramcode")).html($(e.currentTarget).attr("data-display"));
            },
            clearListChoose: function (e) {
                var index = $(e.currentTarget).attr("data-index");
                request.get("Params")[index].ParamValue = null;
                this.$el.find(".list_input").removeClass("active");
                $("#btn_" + $(e.currentTarget).attr("data-paramcode")).html(request.get("Params")[index].ParamName == "" ? request.get("Params")[index].ParamCode : request.get("Params")[index].ParamName);
            }

        });
    }
    if (window.Report.ReportView == undefined) {
        window.Report.ReportView = Backbone.View.extend({
            template_header: _.template($("#tempReportHeader").html()),
            template_body: _.template($("#tempReportBody").html()),
            template_footer:_.template($("#tempReportFooter").html()),
            render: function () {
                this.$el(".reportHeader").html(this.template({ data: report.get("Columns") }));
            },
            showQuery: function () {
                console.info(reportResult);
            }
        });
    }

</script>

<script type="text/javascript">
    var report;
    var queryParamsView;
    var reportView;
    var reportResult;
    var toolbar;
    var request;
    $(function () {
        report = new window.Report.Report();
        request = new window.Report.Request();
        queryParamsView = new window.Report.QueryParamsView({
            el: "#queryParams",
        });
        reportView = new window.Report.ReportView({
            el: "#queryHeader"
        });
        toolbar = new window.Report.ToolbarView({
            el:"#toolbar"
        });
       
    })
</script>

<div class="container">
    <h2 class="text-info" id="queryTitle"></h2>
    <hr />
    <div class="row">
        <form class="form-inline" role="form" id="queryParams" />
    </div>
    <div class="row" style="overflow-x:auto" id="reportView">
        <table class="table table-striped table-hover table-bordered">
            <thead>
                <tr class="reportHeader" style="position:relative" />
            </thead>
            <tbody class="reportBody" />
            <tfoot class="reportSum" />
        </table>
    </div>
    <div class="row" id="reportPagerView">

    </div>
</div>

<div class="navbar navbar-fixed-bottom">
    <div class="navbar-header">
        <div class="btn-group btn-group-lg btn-group-justified" id="toolbar">
            <a class="btn btn-default" data-action="query"><span class="glyphicon glyphicon-search"></span>查询</a>
        </div>
    </div>
</div> 