<script type="text/template" id="tempReportList">
    <%for(var i=0;i<=data.length-1;i++){ %>
        <tr>
            <td><%=data[i].ReportName%></td>
            <td><%=data[i].DBCode%></td>
            <td><%=data[i].Enabled==true?"是":"否"%></td>
            <td><%=data[i].Remark%></td>
            <td>
                <a class="btn btn-default" data-action="del" data-id="<%=i%>"><span class="glyphicon glyphicon-trash"></span></a>
                <a class="btn btn-default" data-action="edit" data-id="<%=i%>"><span class="glyphicon glyphicon-pencil"></span></a>
                <a class="btn btn-default" data-action="enabled" data-id="<%=i%>"><span class="glyphicon glyphicon-eye-open"></span></a>
            </td>
        </tr>
    <%}%>
</script>

<script id="tempReportView" type="text/template">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">报表编辑</h4>
            </div>
            <div class="modal-body">
                <form role="form" id="formReport">
                    <div class="form-group">
                        <label for="reportName">报表名称</label>
                        <input id="reportID" name="ID" type="hidden" value="<%=report.ID%>"/>
                        <input id="reportName" type="text" class="form-control" name="ReportName" value="<%=report.ReportName%>" placeholder="输入报表名称" autofocus="autofocus" required="required" />
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="userName">数据源</label>
                                <br />
                                <div class="btn-group">
                                    <input id="DbId" type="hidden" name="DBID" value="<%=report.DBID%>"/>
                                    <input id="DbCode" type="hidden" name="DBCode" value="<%=report.DBCode%>"/>
                                    <button type="button" class="btn btn-info dropdown-toggle <%=report.DBID==null?'':'disabled'%>" data-toggle="dropdown">
                                        <span id="chooseDbText">
                                            <% if(report.DBID==null){ %>
                                            选择数据源
                                            <%} else{%>
                                            <%=report.DBCode%>
                                            <%}%>
                                        </span>
                                        <span class="caret"></span>
                                    </button>
                                    <ul id="DBList" class="dropdown-menu" role="menu">
                                        <% for(var i=0;i<=dbList.length-1;i++){ %>
                                            <li data-action="chooseDb" data-value="<%=i%>"><a><%=dbList[i].DbCode%></a></li>
                                        <% };%>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label>页合计</label>
                                <br />
                                <div class="btn-group" data-toggle="buttons">
                                    <label id="PageSumabled_t" class="btn btn-info <%=report.PageSumabled==true?'active':''%>">
                                        <input name="PageSumabled" type="radio" value="true" <%=report.PageSumabled==true?'checked':''%>>&nbsp;&nbsp;是&nbsp;&nbsp;
                                    </label>
                                    <label id="PageSumabled_t" class=" btn btn-info <%=report.PageSumabled==false?'active':''%>">
                                        <input name="PageSumabled" type="radio" value="false"<%=report.PageSumabled==false?'checked':''%>>&nbsp;&nbsp;否&nbsp;&nbsp;
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label>总合计</label>
                                <br />
                                <div class="btn-group" data-toggle="buttons">
                                    <label id="AllSumabled_t"class="btn btn-info <%=report.AllSumabled==true?'active':''%>">
                                        <input name="AllSumabled" type="radio" value="true" <%=report.AllSumabled==true?'checked':''%>>&nbsp;&nbsp;是&nbsp;&nbsp;
                                    </label>
                                    <label id="AllSumabled_f" class="btn btn-info  <%=report.AllSumabled==false?'active':''%>">
                                        <input name="AllSumabled" type="radio" value="false" <%=report.AllSumabled==false?'checked':''%>>&nbsp;&nbsp;否&nbsp;&nbsp;
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label>分页</label>
                                <br />
                                <div class="btn-group" data-toggle="buttons">
                                    <label id="pagingabled_t" class="btn btn-info  <%=report.Pagingabled==true?'active':''%>">
                                        <input name="Pagingabled" type="radio" value="true" <%=report.Pagingabled==true?'checked':''%>>&nbsp;&nbsp;是&nbsp;&nbsp;
                                    </label>
                                    <label id="pagingabled_f" class="btn btn-info  <%=report.Pagingabled==false?'active':''%>">
                                        <input name="Pagingabled" type="radio" value="false" <%=report.Pagingabled==false?'checked':''%>>&nbsp;&nbsp;否&nbsp;&nbsp;
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="pageSize">每页显示条数</label>
                                <input id="pageSize" type="text" class="form-control" name="PageSize" value="<%=report.PageSize%>" placeholder="输入条数" autofocus="autofocus" required="required" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <label>参数</label>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover  table-condensed">
                                <thead>
                                    <tr>
                                        <th>参数编码</th>
                                        <th>显示名称</th>
                                        <th>参数类型</th>
                                        <th>输入类型</th>
                                        <th>列表值</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% for(var i=0;i<=report.Params.length-1;i++ ){ %>
                                    <tr>
                                        <td style="vertical-align:middle"><%=report.Params[i].ParamCode%></td>
                                        <td><input type="text" class="form-control" data-index="<%=i%>" data-action="paramNameChanged" value="<%=report.Params[i].ParamName%>" placeholder="<%=report.Params[i].ParamCode%>" /></td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                                                    <span id="paramTypeText_<%=i%>"> <%=report.Params[i].ParamTypeName%></span> <span class="caret"></span>
                                                </button>
                                                <ul id="paramTypeList_<%=i%>" class="dropdown-menu" role="menu">
                                                    <li data-action="chooseParamType" data-index="<%=i%>" data-value="0" class="<%=report.Params[i].ParamType=='0'?'active':''%>"><a>字符型</a></li>
                                                    <li data-action="chooseParamType" data-index="<%=i%>" data-value="1" class="<%=report.Params[i].ParamType=='1'?'active':''%>"><a>数值型</a></li>
                                                    <li data-action="chooseParamType" data-index="<%=i%>" data-value="2" class="<%=report.Params[i].ParamType=='2'?'active':''%>"><a>日期型</a></li>
                                                </ul>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <input type="hidden" id="paramInputType_<%=i%>" value="<%report.Params[i].ParamInputType%>">
                                                <button id="btn_InputType_<%=i%>" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                                                    <span id="paramInputTypeText_<%=i%>"><%=report.Params[i].ParamInputTypeName%></span> <span class="caret"></span>
                                                </button>
                                                <ul id="paramInputTypeList_<%=i%>" class="dropdown-menu" role="menu">
                                                    <li data-action="chooseParamInputType" data-index="<%=i%>" data-value="0" class="<%=report.Params[i].ParamInputType=='0'?'active':''%>"><a>手动输入</a></li>
                                                    <li data-action="chooseParamInputType" data-index="<%=i%>" data-value="1" class="<%=report.Params[i].ParamInputType=='1'?'active':''%>"><a>列表选择</a></li>
                                                </ul>
                                            </div>
                                        </td>
                                        <td>
                                        <input id="paramItemsString_<%=i%>" data-action="paramItemsStringChanged" data-index="<%=i%>" value="<%report.Params[i].ParamItemString%>" type="text" class="form-control" <%=report.Params[i].ParamInputType=='0'?'readonly':''%> placeholder="例：p1=123;p2=abc">
                                        </td>
                                    </tr>
                                    <% }; %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>字段</label>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover  table-condensed">
                                <thead>
                                    <tr>
                                        <th>字段编码</th>
                                        <th>显示名称</th>
                                        <th>排序</th>
                                        <th>求和</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% for(var i=0;i<=report.Columns.length-1;i++){ %>
                                    <tr>
                                        <td style="vertical-align:middle"><%=report.Columns[i].ColumnCode%></td>
                                        <td><input  type="text" class="form-control" value="<%=report.Columns[i].ColumnName%>" placeholder="<%=report.Columns[i].ColumnCode%>" /></td>
                                        <td>
                                            <input type="checkbox" <%=report.Columns[i].Sumabled==true?'checked':''%> >
                                        </td>
                                        <td>
                                            <input type="checkbox" <%=report.Columns[i].Sumabled==true?'checked':''%> >
                                        </td>
                                    </tr>
                                    <%}%>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sqlCommand">SQL语句</label><a id="btnRebuild" class="btn btn-sm btn-warning pull-right">生成参数和列 </a>  
                        <textarea id="sqlCommand" class="form-control" name="SqlCommand" rows="3"><%=report.SqlCommand%></textarea>                     
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a class="btn btn-default" data-dismiss="modal">关闭</a>
                <a class="btn btn-primary" id="btnSave">保存</a>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
    if (window.ReportManage == undefined) {
        Tools.Namespace.register("window.ReportManage");
    }
    
    if (window.ReportManage.Toolbar == undefined) {
        window.ReportManage.Toolbar = Backbone.View.extend({
            events: {
                "click a": "clickBtn"
            },
            clickBtn: function (e) {
                switch ($(e.currentTarget).attr("data-action")) {
                    case "add":
                        reportView.show(null);
                        break;
                    case "refresh":
                        reportListView.refresh();
                        break;
                }
            }

        });
    }
   
    if (window.ReportManage.Report == undefined) {
        window.ReportManage.Report = Backbone.Model.extend({
            defaults: {
                "ID": null,
                "DBID": null,
                "DBCode": "",
                "ReportName": "",
                "Enabled": true,
                "Remark": "",
                "Columns": [],
                "Params": [],
                "SqlCommand": "",
                "PageSumabled": false,
                "AllSumabled": false,
                "Pagingabled": false,
                "PageSize": 10
            },
            idAttribute:"ID",
            urlRoot:"/api/Report"
        });
    }

    if (window.ReportManage.ReportList == undefined) {
        window.ReportManage.ReportList = Backbone.Collection.extend({
            model: window.ReportManage.Report,
            url: "/api/Report"
        });
    }
    
    if (window.ReportManage.ReportListView == undefined) {
        window.ReportManage.ReportListView = Backbone.View.extend({
            template: _.template($("#tempReportList").html()),
            render: function (data) {
                this.$el.html(this.template(data));
            },
            refresh: function () {
                reportList.fetch({
                    success: function (collection, response, options) {
                        
                        reportListView.render({ data: response });
                    },
                    error: function (e) {
                        alert(e.responseJSON.Message);
                    }
                });
            },
            events: {
                "click a": function (e) {
                    switch ($(e.currentTarget).attr("data-action")) {
                        case "del":
                            break;
                        case "edit":
                            var rpt = reportList.at($(e.currentTarget).attr("data-id"));
                            rpt.fetch({
                                success: function () {
                                    reportView.show(rpt);
                                },
                                error: function () {
                                    alert("报表明细读取失败");
                                }
                            });
                            
                            break;
                        case "enabled":
                            break;
                    }
                }
            }
        });
    }
    if (window.ReportManage.ReportView == undefined) {
        window.ReportManage.ReportView = Backbone.View.extend({
            curReport:null,
            template: _.template($("#tempReportView").html()),
            render: function () {
                this.$el.html(this.template({
                    "report": this.curReport.toJSON(this.curReport),
                    "dbList": dbList.toJSON(dbList)//此处添加数据源变量
                }));
            },
            //传入的data是window.ReportManage.Report的实例
            show: function (data) {
                this.curReport = data==null?new window.ReportManage.Report():data;
                this.render();
                this.$el.modal({
                    show: true,
                    keyboard: false,
                    backdrop: false
                });
            },
            events: {
                "click #btnRebuild": "buildReport",
                "click #btnSave": "saveReport",
                "click li": "choose",
                "change input":"valueChanged"
            },
            valueChanged: function (e) {
                switch ($(e.currentTarget).attr("data-action")) {
                    case "paramNameChanged":
                        @*参数名改变*@
                        var index = $(e.currentTarget).attr("data-index");
                        var param = this.curReport.get("Params")[index];
                        param.ParamName = $(e.currentTarget).val();
                        break;
                    case "paramItemsStringChanged":
                        @*参数列表值改变*@
                        var index = $(e.currentTarget).attr("data-index");
                        var param = this.curReport.get("Params")[index];
                        param.ParamItemString = $(e.currentTarget).val();
                        break;
                }
                
            },
            choose: function (e) {
                switch ($(e.currentTarget).attr("data-action")) {
                    case "chooseDb":
                        @*选择数据源*@
                        var db = dbList.at( $(e.currentTarget).attr("data-value"));
                        $("#DbId").val(db.get("ID"));
                        $("#DbCode").val(db.get("DbCode"));
                        $("#chooseDbText").html(db.get("DbCode"));
                        $("#DBList li").removeClass("active");
                        $(e.currentTarget).addClass("active");
                        break;
                    case "chooseParamType":
                        @*选择参数类型*@
                        var index = $(e.currentTarget).attr("data-index");
                        var value = $(e.currentTarget).attr("data-value");
                        var text;
                        switch (value) {
                            case "0":
                                text = "字符型";
                                break;
                            case "1":
                                text = "数值型";
                                break;
                            case "2":
                                text = "日期型";
                                break;
                        }
                        if (value == "2") {
                            $("#btn_InputType_"+index).addClass("disabled");
                        }
                        else {
                            $("#btn_InputType_" + index).removeClass("disabled");
                        }
                        var params = this.curReport.get("Params");
                        params[index].ParamType = value;
                        params[index].ParamTypeName = text;
                        $("#paramTypeText_" + index).html(text);
                        $("#paramTypeList_" + index +" li").removeClass("active");
                        $(e.currentTarget).addClass("active");
                        break;
                    case "chooseParamInputType":
                        @*选择参数输入类型*@
                        var index = $(e.currentTarget).attr("data-index");
                        var value = $(e.currentTarget).attr("data-value");
                        var text;
                        switch (value) {
                            case "0":
                                text = "手动输入";
                                break;
                            case "1":
                                text = "列表选择";
                                break;
                        }
                        if (value == "0") {
                            $("#paramItemsString_" + index).attr("readonly", "readonly");
                        }
                        else {
                            $("#paramItemsString_" + index).removeAttr("readonly");
                        }
                        var params = this.curReport.get("Params");
                        params[index].ParamInputType = value;
                        params[index].ParamInputTypeName = text;
                        $("#paramInputTypeText_" + index).html(text);
                        $("#paramInputTypeList_" + index + " li").removeClass("active");
                        $(e.currentTarget).addClass("active");
                        break;

                }
            },
            saveReport: function () {
                var rpt = Tools.serializeObject($("#formReport"));
                this.curReport.set(rpt);
                console.info(this.curReport.toJSON(this.curReport));
            },
            buildReport: function () {
                var sql=$("#sqlCommand").val();
                var dbid=$("#DbId").val();
                if ( sql=="") {
                    alert("请先输入SQL语句");
                    return;
                }
                if(dbid==""){
                    alert("请选择数据库");
                    return;
                }
                var rpt = this.curReport.clone();
                if (rpt.get("ID") == null) {
                    @*将id设为0*@
                    rpt.set({ "ID": 0 });
                }
                rpt.fetch({
                    data: {
                        DBID:1,//临时赋值1
                        sql:sql
                    },
                    success: function (model, rst, status) {
                        if (rst==null) {
                            @*重构失败*@
                            alert("重构失败，请检查SQL语句");
                            return;
                        }
                        rst.DBID = $("#DbId").val();
                        rst.DBCode = $("#DbCode").val();
                        rst.ReportName = $("#reportName").val();
                        rst.AllSumabled = $("#AllSumabled_t").hasClass("active");
                        rst.PageSumabled = $("#PageSumabled_t").hasClass("active");
                        rst.PageSize = $("#pageSize").val();
                        rst.Pagingabled = $("#Pagingabled_t").hasClass("active");
                        reportView.curReport.set(rst);
                        reportView.render();
                    },
                    error: function () {
                        alert("重构失败");
                    }
                });
                
            }
        });
    }

    //Database
    if (window.ReportManage.DbModel == undefined) {
        window.ReportManage.DbModel = Backbone.Model.extend({
            defaults: {
                "ID": null,
                "DbCode": null,
                "DbName": null
            },
            idAttribute: "ID",
            urlRoot: "/api/Database"
        });
    }
    if (window.ReportManage.DbList == undefined) {
        window.ReportManage.DbList = Backbone.Collection.extend({
            model: window.ReportManage.DbModel,
            url: "/api/Database"
        });
    }
</script>

<script type="text/javascript">
    var toolbar;
    var reportList;
    var reportListView;
    var reportView;
    var dbList;
    $(function () {
        
        toolbar = new window.ReportManage.Toolbar({
            el: "#toolbar"
        });
        reportList = new window.ReportManage.ReportList();
        reportListView = new window.ReportManage.ReportListView({
            el: "#reportList"
        });
        reportView = new window.ReportManage.ReportView({
            el: "#reportView"
        });
        dbList = new window.ReportManage.DbList();
        dbList.fetch({
            error: function () {
                alert("获取数据库列表失败");
            }
        });
        reportListView.refresh();
    })
</script>

<div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>报表名</th>
                <th>数据源</th>
                <th>可用</th>
                <th>说明</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="reportList"></tbody>
    </table> 
</div>

<div class="modal fade" aria-hidden="true" id="reportView"/>

<div class="navbar navbar-fixed-bottom">
    <div class="navbar-header">
        <div class="btn-group btn-group-lg btn-group-justified" id="toolbar">
            <a class="btn btn-default" data-action="refresh"><span class="glyphicon glyphicon-refresh"></span>刷新</a>
            <a class="btn btn-default" data-action="add"><span class="glyphicon glyphicon-plus"></span>新建</a>
        </div>
    </div>
</div> 